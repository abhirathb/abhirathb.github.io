name: Convert Markdown to HTML

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'posts/*.md'

jobs:
  convert:
    runs-on: ubuntu-latest

    # Only run if the commit came from merging an addcont/* branch
    if: contains(github.event.head_commit.message, 'addcont/') || startsWith(github.ref_name, 'addcont/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits to compare changes

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install markdown pyyaml python-frontmatter

      - name: Get changed markdown files
        id: changed-files
        run: |
          # Get list of changed .md files in posts/ directory
          CHANGED_MD_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^posts/.*\.md$' || echo "")

          if [ -z "$CHANGED_MD_FILES" ]; then
            echo "No markdown files changed in posts/"
            echo "files_found=false" >> $GITHUB_OUTPUT
          else
            echo "Changed markdown files:"
            echo "$CHANGED_MD_FILES"
            echo "files_found=true" >> $GITHUB_OUTPUT
            # Convert newlines to spaces for passing to script
            echo "md_files=$(echo $CHANGED_MD_FILES | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi

      - name: Convert markdown to HTML
        if: steps.changed-files.outputs.files_found == 'true'
        run: |
          python .github/scripts/convert_md_to_html.py

      - name: Update index.html with new posts
        if: steps.changed-files.outputs.files_found == 'true'
        run: |
          python .github/scripts/update_index.py

      - name: Commit and push generated files
        if: steps.changed-files.outputs.files_found == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add generated HTML files, category pages, and updated index
          git add posts/*.html
          git add categories/*.html 2>/dev/null || true
          git add index.html
          git add posts_metadata.json

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-generate HTML from markdown posts and update index"
            git push
          fi
